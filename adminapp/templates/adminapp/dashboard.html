{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="{% static 'adminapp/css/mystyle.css' %}">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        table thead {
            background-color: #0f1b36;
            color: white;
        }

        table th, table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>Revenue Cycle</h1>
    </div>
    
    <div class="sidebar">
    <ul>
        <li class="{% if 'dashboard' in request.path %}active{% endif %}">
        <a href="{% url 'admin_dashboard' %}">
            <i data-lucide="layout-dashboard" class="icon"></i> Dashboard
        </a>
        </li>
        <li class="{% if 'user' in request.path %}active{% endif %}">
        <a href="{% url 'user_list' %}">
            <i data-lucide="user" class="icon"></i> Customer
        </a>
        </li>
        <li class="{% if 'subscription' in request.path %}active{% endif %}">
        <a href="{% url 'subscription_list' %}">
            <i data-lucide="package" class="icon"></i> Subscription
        </a>
        </li>
        <li class="{% if 'billing_list' in request.path %}active{% endif %}">
            <a href="{% url 'billing_list' %}">
                <i data-lucide="credit-card" class="icon"></i> Billing
            </a>
        </li>
        <li class="{% if 'report' in request.path %}active{% endif %}">
        <a href="{% url 'billing_report' %}">
            <i data-lucide="bar-chart-2" class="icon"></i> Report
        </a>
        </li>
        <li>
        <a href="{% url 'logout' %}">
            <i data-lucide="log-out" class="icon"></i> Logout
        </a>
        </li>
    </ul>
    </div>

    <div class="main-content">
        <div class="grid">
            <div class="summary-card">
                <h3>Total Revenue</h3>
                <p>IDR {{ total_revenue }}</p>
            </div>
            <div class="summary-card">
                <h3>Unpaid Revenue</h3>
                <p>IDR {{ unpaid_revenue }}</p>
            </div>
            <div class="summary-card">
                <h3>Total Customer</h3>
                <p>{{ total_users }}</p>
            </div>
            <div class="summary-card">
                <h3>Payment Ratio</h3>
                <p>{{ payment_ratio|floatformat:2 }}%</p>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Revenue Graph</h2>
                <canvas id="revenueChart"></canvas>
            </div>
            <div class="card">
                <h2>Active Users Ratio</h2>
                <canvas id="userRatioChart"></canvas>
                <div style="margin-top: 10px;">
                    <p><span style="color:#0f1b36; font-weight:bold;">Active:</span> {{ active_users }}</p>
                    <p><span style="color:#ccc; font-weight:bold;">Inactive:</span> {{ inactive_users }}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Recent Subscriptions</h2>
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>User</th>
                        <th>Plan</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in recent_subscriptions %}
                    <tr>
                        <td>{{ s.order_id }}</td>
                        <td>{{ s.user.username }}</td>
                        <td>{{ s.plan.name }}</td>
                        <td>IDR {{ s.plan.price }}</td>
                        <td>{{ s.status }}</td>
                        <td>{{ s.created_at }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Revenue Chart
        const ctx = document.getElementById('revenueChart').getContext('2d');
        const revenueChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_data.labels|safe }},
                datasets: [{
                    label: 'Monthly Revenue',
                    data: {{ chart_data.data|safe }},
                    backgroundColor: 'rgba(15, 27, 54, 0.2)',
                    borderColor: 'rgba(15, 27, 54, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointBackgroundColor: 'rgba(15, 27, 54, 1)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'IDR ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Donut Chart for Active Users
        const userRatioCtx = document.getElementById('userRatioChart').getContext('2d');
        const userRatioChart = new Chart(userRatioCtx, {
            type: 'doughnut',
            data: {
                labels: ['Active', 'Inactive'],
                datasets: [{
                    data: [{{ active_users }}, {{ inactive_users }}],
                    backgroundColor: ['#0f1b36', '#d3d9e3'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed} users`;
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
