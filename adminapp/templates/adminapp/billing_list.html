{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'adminapp/css/mystyle.css' %}">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        table thead {
            background-color: #0f1b36;
            color: white;
        }

        table th, table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>Revenue Cycle</h1>
    </div>
    
    <div class="sidebar">
    <ul>
        <li class="{% if 'dashboard' in request.path %}active{% endif %}">
        <a href="{% url 'admin_dashboard' %}">
            <i data-lucide="layout-dashboard" class="icon"></i> Dashboard
        </a>
        </li>
        <li class="{% if 'user' in request.path %}active{% endif %}">
        <a href="{% url 'user_list' %}">
            <i data-lucide="user" class="icon"></i> Customer
        </a>
        </li>
        <li class="{% if 'subscription' in request.path %}active{% endif %}">
        <a href="{% url 'subscription_list' %}">
            <i data-lucide="package" class="icon"></i> Subscription
        </a>
        </li>
        <li class="{% if 'billing_list' in request.path %}active{% endif %}">
            <a href="{% url 'billing_list' %}">
                <i data-lucide="credit-card" class="icon"></i> Billing
            </a>
        </li>
        <li class="{% if 'report' in request.path %}active{% endif %}">
        <a href="{% url 'billing_report' %}">
            <i data-lucide="bar-chart-2" class="icon"></i> Report
        </a>
        </li>
        <li>
        <a href="{% url 'logout' %}">
            <i data-lucide="log-out" class="icon"></i> Logout
        </a>
        </li>
    </ul>
    </div>

  <main class="main-content">
    <h1 class="text-3xl font-bold mb-6">Billing List</h1>

    <!-- Filter Form -->
    <form method="get" class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
      <input type="text" name="q" placeholder="Search Invoice ID or User"
             value="{{ request.GET.q }}"
             class="w-full sm:w-1/3 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <select name="status"
              class="w-full sm:w-1/4 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none">
        <option value="">All Status</option>
        <option value="Paid" {% if request.GET.status == "Paid" %}selected{% endif %}>Paid</option>
        <option value="Failed" {% if request.GET.status == "Failed" %}selected{% endif %}>Failed</option>
      </select>

      <select name="payment_method"
              class="w-full sm:w-1/4 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none">
        <option value="">All Payment Methods</option>
        <option value="Credit Card" {% if request.GET.payment_method == "Credit Card" %}selected{% endif %}>Credit Card</option>
        <option value="Bank Transfer" {% if request.GET.payment_method == "Bank Transfer" %}selected{% endif %}>Bank Transfer</option>
      </select>

      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow hover:bg-blue-700">
        Filter
      </button>
    </form>

    <!-- Billing Table -->
    <div class="overflow-auto rounded-lg shadow border border-gray-200">
      <table class="min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-100 text-gray-700 font-semibold text-left">
          <tr>
            <th class="px-4 py-3">Invoice ID</th>
            <th class="px-4 py-3">User</th>
            <th class="px-4 py-3">Plan Type</th>
            <th class="px-4 py-3">Billing Period</th>
            <th class="px-4 py-3">Amount Charged</th>
            <th class="px-4 py-3">Status</th>
            <th class="px-4 py-3">Payment Method</th>
            <th class="px-4 py-3">Auto-renewal</th>
            <th class="px-4 py-3">Created Date</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for s in subscriptions %}
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-2 font-mono text-blue-800">{{ s.order_id }}</td>
            <td class="px-4 py-2">{{ s.user.email }}</td>
            <td class="px-4 py-2">{{ s.plan.name }}</td>
            <td class="px-4 py-2">{{ s.start_date }} - {{ s.end_date }}</td>
            <td class="px-4 py-2 font-semibold text-green-700">IDR{{ s.total_price }}</td>
            <td class="px-4 py-2 capitalize">{{ s.status }}</td>
            <td class="px-4 py-2 capitalize">{{ s.payment_method }}</td>
            <td class="px-4 py-2">{% if s.auto_renewal %}Yes{% else %}No{% endif %}</td>
            <td class="px-4 py-2 text-gray-500">{{ s.created_at }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="px-4 py-4 text-center text-gray-400">No invoices found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    </main>

    <script>
  <script src="https://unpkg.com/lucide/dist/lucide.min.js"></script>
  <script>
    lucide.createIcons();
  </script>
</script>

    <script>
        // Revenue Chart
        const ctx = document.getElementById('revenueChart').getContext('2d');
        const revenueChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_data.labels|safe }},
                datasets: [{
                    label: 'Monthly Revenue',
                    data: {{ chart_data.data|safe }},
                    backgroundColor: 'rgba(15, 27, 54, 0.2)',
                    borderColor: 'rgba(15, 27, 54, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointBackgroundColor: 'rgba(15, 27, 54, 1)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'IDR ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Donut Chart for Active Users
        const userRatioCtx = document.getElementById('userRatioChart').getContext('2d');
        const userRatioChart = new Chart(userRatioCtx, {
            type: 'doughnut',
            data: {
                labels: ['Active', 'Inactive'],
                datasets: [{
                    data: [{{ active_users }}, {{ inactive_users }}],
                    backgroundColor: ['#0f1b36', '#d3d9e3'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed} users`;
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
